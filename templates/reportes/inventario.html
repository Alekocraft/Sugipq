{% extends "base.html" %}
{% block title %}Reporte de Inventario{% endblock %}
{% block styles %}
<style>
    .valor-total {
        font-size: 1.5em;
        font-weight: bold;
        color: #28a745;
    }
    .valor-promedio {
        font-size: 1.2em;
        color: #17a2b8;
    }
    .badge-stock {
        min-width: 40px;
        font-size: 0.9em;
        padding: 4px 8px;
    }
    .table th {
        font-weight: 600;
        font-size: 0.85rem;
    }
    .table td {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1 text-warning">
                <i class="fas fa-chart-line me-2"></i>Reporte de Inventario
            </h1>
            <p class="text-muted small">Valoración y estadísticas del inventario</p>
        </div>
        <div>
            <a href="/reportes" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
        </div>
    </div>

    <!-- Estadísticas generales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Total Productos</h6>
                    <h2 class="fw-bold">{{ total_productos }}</h2>
                    <small class="text-muted">Materiales en inventario</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Valor Total</h6>
                    <h2 class="valor-total">${{ "{:,.0f}".format(valor_total_inventario|default(0)|float) }}</h2>
                    <small class="text-muted">Valoración total</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Valor Promedio</h6>
                    <h2 class="valor-promedio">${{ "{:,.0f}".format(valor_promedio|default(0)|float) }}</h2>
                    <small class="text-muted">Por producto</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Stock Total</h6>
                    <h2 class="fw-bold text-info">
                        {% set total_stock = productos|sum(attribute='cantidad') %}
                        {{ total_stock }}
                    </h2>
                    <small class="text-muted">Unidades totales</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Distribución por oficina -->
    {% if ubicaciones %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-primary text-white py-3">
            <h6 class="fw-semibold mb-0">
                <i class="fas fa-chart-pie me-2"></i>Distribución por Oficina
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% for ubicacion in ubicaciones %}
                <div class="col-md-4 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-semibold mb-0">{{ ubicacion.nombre }}</h6>
                                <span class="badge bg-primary">{{ ubicacion.cantidad }}</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: {{ (ubicacion.cantidad / total_productos * 100) if total_productos > 0 else 0 }}%">
                                </div>
                            </div>
                            <small class="text-muted">
                                {{ ((ubicacion.cantidad / total_productos * 100) if total_productos > 0 else 0)|round(1) }}% del total
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabla de productos -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-success text-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="fw-semibold mb-0">
                    <i class="fas fa-table me-2"></i>Detalle del Inventario
                    <span class="badge bg-light text-dark ms-2">{{ productos|length }}</span>
                </h6>
                <div class="d-flex gap-2">
                    <button onclick="exportarExcel()" class="btn btn-light btn-sm">
                        <i class="fas fa-file-excel text-success me-1"></i>Excel
                    </button>
                    <button onclick="exportarPDF()" class="btn btn-light btn-sm">
                        <i class="fas fa-file-pdf text-danger me-1"></i>PDF
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                <table id="tablaInventario" class="table table-hover table-sm align-middle mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th class="ps-3">ID</th>
                            <th>Material</th>
                            <th class="text-end">V. Unitario</th>
                            <th class="text-center">Stock</th>
                            <th class="text-end">V. Total</th>
                            <th>Oficina</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos %}
                        <tr>
                            <td class="ps-3 fw-semibold small">{{ producto.id }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-box me-2 text-muted small"></i>
                                    <div>
                                        <strong class="small">{{ producto.nombre }}</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="text-end fw-semibold small">${{ "{:,.0f}".format(producto.valor_unitario|float) }}</td>
                            <td class="text-center">
                                <span class="badge badge-stock {% if producto.cantidad > 10 %}bg-success{% elif producto.cantidad > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ producto.cantidad }}
                                </span>
                            </td>
                            <td class="text-end fw-bold text-primary small">${{ "{:,.0f}".format(producto.valor_total|float) }}</td>
                            <td class="small">{{ producto.oficina_nombre }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h6 class="text-muted">No se encontraron materiales</h6>
                                    <p class="text-muted small">No hay materiales en el inventario</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Incluir las librerías para exportación -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
function exportarExcel() {
    try {
        const tabla = document.getElementById('tablaInventario');
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(tabla);
        XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
        
        // Formatear columnas de dinero
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let C = 2; C <= range.e.c; C++) { // Columnas C y E son valores
            if (C === 2 || C === 4) { // Columna C: V. Unitario, Columna E: V. Total
                for (let R = range.s.r + 1; R <= range.e.r; R++) {
                    const cell_address = {c: C, r: R};
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (ws[cell_ref]) {
                        ws[cell_ref].z = '"$"#,##0.00';
                    }
                }
            }
        }
        
        XLSX.writeFile(wb, `Reporte_Inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
        mostrarNotificacion('✅ Excel exportado correctamente', 'success');
    } catch (error) {
        console.error('Error en exportación Excel:', error);
        mostrarNotificacion('❌ Error al exportar a Excel', 'error');
    }
}

function exportarPDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');

        // Título
        doc.setFontSize(16);
        doc.setTextColor(40, 40, 40);
        doc.text('Reporte de Inventario - Sistema de Gestión', 14, 15);
        
        // Subtítulo
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`Generado: ${new Date().toLocaleDateString('es-ES', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric' 
        })}`, 14, 22);
        doc.text(`Total productos: {{ productos|length }}`, 14, 28);
        doc.text(`Valor total: ${{ "{:,.2f}".format(valor_total_inventario|default(0)|float) }}`, 14, 34);

        // Tabla
        doc.autoTable({
            html: '#tablaInventario',
            startY: 42,
            theme: 'grid',
            headStyles: { 
                fillColor: [40, 167, 69], // Verde
                textColor: [255, 255, 255],
                fontSize: 9,
                fontStyle: 'bold'
            },
            bodyStyles: { 
                fontSize: 8,
                cellPadding: 3
            },
            columnStyles: {
                0: { cellWidth: 20 }, // ID
                1: { cellWidth: 60 }, // Material
                2: { cellWidth: 25, halign: 'right' }, // V. Unitario
                3: { cellWidth: 20, halign: 'center' }, // Stock
                4: { cellWidth: 25, halign: 'right' }, // V. Total
                5: { cellWidth: 40 } // Oficina
            },
            styles: { 
                overflow: 'linebreak',
                cellWidth: 'wrap'
            },
            margin: { left: 10, right: 10 }
        });

        doc.save(`Reporte_Inventario_${new Date().toISOString().split('T')[0]}.pdf`);
        mostrarNotificacion('✅ PDF exportado correctamente', 'success');
    } catch (error) {
        console.error('Error en exportación PDF:', error);
        mostrarNotificacion('❌ Error al exportar a PDF', 'error');
    }
}

function mostrarNotificacion(mensaje, tipo) {
    // Crear toast simple
    const toastHTML = `
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1060">
            <div class="toast align-items-center text-white bg-${tipo === 'success' ? 'success' : 'danger'} border-0 show" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        ${mensaje}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>
    `;
    
    // Insertar en el DOM
    const div = document.createElement('div');
    div.innerHTML = toastHTML;
    document.body.appendChild(div.firstElementChild);
    
    // Auto-eliminar después de 3 segundos
    setTimeout(() => {
        const toastElement = document.querySelector('.toast');
        if (toastElement) {
            toastElement.classList.remove('show');
            setTimeout(() => toastElement.remove(), 300);
        }
    }, 3000);
}

// Añadir tooltips a los botones
document.addEventListener('DOMContentLoaded', function() {
    // Tooltips para botones de exportación
    const excelBtn = document.querySelector('button[onclick="exportarExcel()"]');
    const pdfBtn = document.querySelector('button[onclick="exportarPDF()"]');
    
    if (excelBtn) {
        excelBtn.setAttribute('title', 'Exportar a Excel');
        excelBtn.setAttribute('data-bs-toggle', 'tooltip');
    }
    
    if (pdfBtn) {
        pdfBtn.setAttribute('title', 'Exportar a PDF');
        pdfBtn.setAttribute('data-bs-toggle', 'tooltip');
    }
    
    // Inicializar tooltips de Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<style>
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table th {
        white-space: nowrap;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #dee2e6;
        padding: 0.75rem 0.5rem;
        background-color: #f8f9fa;
    }
    
    .table td {
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
        font-size: 0.85rem;
        border-top: 1px solid #f0f0f0;
    }
    
    .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        min-width: 70px;
    }
    
    .badge {
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.35em 0.65em;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
        transition: background-color 0.2s;
    }
</style>
{% endblock %}