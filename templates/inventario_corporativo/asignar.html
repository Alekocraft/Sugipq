{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">

    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Asignar inventario corporativo</h1>
        <a href="{{ url_for('inventario_corporativo.ver_inventario_corporativo', producto_id=producto.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row g-4">
        <!-- Info del producto -->
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-box"></i> Producto</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2"><strong>Código único:</strong> {{ producto.codigo_unico }}</div>
                    <div class="mb-2"><strong>Nombre:</strong> {{ producto.nombre }}</div>
                    {% if producto.descripcion %}
                    <div class="mb-2"><strong>Descripción:</strong> {{ producto.descripcion }}</div>
                    {% endif %}
                    <div class="mb-2"><strong>Categoría:</strong> {{ producto.categoria }}</div>
                    <div class="mb-2"><strong>Marca / Modelo:</strong> {{ producto.marca }} {{ producto.modelo }}</div>
                    {% if producto.serial_number %}
                    <div class="mb-2"><strong>Serial:</strong> {{ producto.serial_number }}</div>
                    {% endif %}
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span><strong>Total:</strong> {{ producto.cantidad_total }}</span>
                        <span><strong>Disponible:</strong> {{ producto.cantidad_disponible }}</span>
                    </div>
                </div>
            </div>

            <!-- Historial -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Historial de asignaciones</h5>
                </div>
                <div class="card-body">
                    {% if historial and historial|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Oficina</th>
                                        <th>Usuario</th>
                                        <th>Cant.</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for h in historial %}
                                    <tr>
                                        <td>
                                            {{ h.fecha_asignacion.strftime('%Y-%m-%d') if h.fecha_asignacion else '-' }}
                                        </td>
                                        <td>
                                            {{ h.nombre_oficina }}
                                            {% if h.ubicacion_oficina %}
                                                <div class="text-muted small">{{ h.ubicacion_oficina }}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ h.usuario_asignado or '-' }}
                                            {% if h.usuario_email %}
                                                <div class="text-muted small">{{ h.usuario_email }}</div>
                                            {% endif %}
                                        </td>
                                        <td>{{ h.cantidad }}</td>
                                        <td>{{ h.estado }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No hay asignaciones registradas para este producto.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Formulario de asignación -->
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-check"></i> Nueva asignación</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('inventario_corporativo.asignar_inventario_corporativo', producto_id=producto.id) }}">
                        <div class="row g-3">
                            <div class="col-md-7">
                                <label class="form-label">Oficina</label>
                                <select class="form-select" name="oficina_id" required>
                                    <option value="">Seleccione una oficina…</option>
                                    {% for oficina in oficinas %}
                                        <option value="{{ oficina.id }}">{{ oficina.nombre }}{% if oficina.ubicacion %} — {{ oficina.ubicacion }}{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Cantidad</label>
                                <input type="number" class="form-control" name="cantidad" min="1" max="{{ producto.cantidad_disponible }}" value="1" required>
                                <div class="form-text">Máx: {{ producto.cantidad_disponible }}</div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="mb-0"><i class="fas fa-id-card"></i> Usuario asignado</h6>
                            {% if ldap_disponible %}
                                <span class="badge bg-success">AD disponible</span>
                            {% else %}
                                <span class="badge bg-secondary">AD no disponible</span>
                            {% endif %}
                        </div>

                        {% if ldap_disponible %}
                        <div class="mb-3">
                            <label class="form-label">Buscar en Active Directory</label>
                            <input type="text" class="form-control" id="buscarUsuario" placeholder="Escribe nombre, usuario o correo…">
                            <div class="form-text">Los resultados aparecen abajo. Selecciona uno para completar los campos.</div>
                            <ul class="list-group mt-2" id="resultadosBusqueda" style="max-height: 220px; overflow-y: auto;"></ul>
                        </div>
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Username (AD)</label>
                                <input type="text" class="form-control" id="usuario_ad_username" name="usuario_ad_username" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="usuario_ad_nombre" name="usuario_ad_nombre" {% if ldap_disponible %}readonly{% endif %}>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Correo</label>
                                <input type="email" class="form-control" id="usuario_ad_email" name="usuario_ad_email" {% if ldap_disponible %}readonly{% endif %}>
                            </div>
                        </div>

                        <div class="d-flex gap-3 align-items-center mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="enviar_notificacion" id="enviar_notificacion" value="1" checked>
                                <label class="form-check-label" for="enviar_notificacion">
                                    Enviar notificación por correo
                                </label>
                            </div>

                            <button type="button" class="btn btn-outline-secondary btn-sm" id="limpiarUsuario">
                                Limpiar usuario
                            </button>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{{ url_for('inventario_corporativo.ver_inventario_corporativo', producto_id=producto.id) }}" class="btn btn-outline-secondary">
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Asignar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Ayuda -->
            <div class="alert alert-info mt-4 mb-0">
                <i class="fas fa-info-circle"></i>
                <strong>Tip:</strong> Si el AD no está disponible, puedes escribir el nombre y correo manualmente.
            </div>
        </div>
    </div>
</div>

{% if ldap_disponible %}
<script>
(function () {
    const input = document.getElementById('buscarUsuario');
    const resultados = document.getElementById('resultadosBusqueda');

    const usernameEl = document.getElementById('usuario_ad_username');
    const nombreEl = document.getElementById('usuario_ad_nombre');
    const emailEl = document.getElementById('usuario_ad_email');
    const limpiarBtn = document.getElementById('limpiarUsuario');

    let debounceTimer = null;
    let activeController = null;

    function limpiarResultados() {
        while (resultados.firstChild) resultados.removeChild(resultados.firstChild);
    }

    function setUsuario(u) {
        usernameEl.value = u.samAccountName || '';
        nombreEl.value = u.displayName || '';
        emailEl.value = u.email || '';
        limpiarResultados();
        if (input) input.value = u.displayName || u.samAccountName || '';
    }

    function renderResultados(usuarios) {
        limpiarResultados();
        if (!usuarios || usuarios.length === 0) return;

        usuarios.forEach((u) => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';

            const primary = document.createElement('div');
            primary.textContent = u.displayName || u.samAccountName || '(sin nombre)';
            li.appendChild(primary);

            if (u.email) {
                const secondary = document.createElement('small');
                secondary.className = 'text-muted';
                secondary.textContent = u.email;
                li.appendChild(secondary);
            }

            li.addEventListener('click', function () { setUsuario(u); });
            resultados.appendChild(li);
        });
    }

    async function buscar(q) {
        if (!q || q.trim().length < 2) {
            limpiarResultados();
            return;
        }

        if (activeController) activeController.abort();
        activeController = new AbortController();

        const url = new URL("{{ url_for('inventario_corporativo.api_buscar_usuarios_ad') }}", window.location.origin);
        url.searchParams.set('q', q);

        try {
            const res = await fetch(url.toString(), { signal: activeController.signal, headers: { 'Accept': 'application/json' } });
            if (!res.ok) return;

            const data = await res.json();
            renderResultados(data.usuarios || []);
        } catch (e) {
            // si se aborta, no hacemos nada
        }
    }

    if (input) {
        input.addEventListener('input', function (e) {
            const q = e.target.value || '';
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => buscar(q), 300);
        });
    }

    if (limpiarBtn) {
        limpiarBtn.addEventListener('click', function () {
            usernameEl.value = '';
            nombreEl.value = '';
            emailEl.value = '';
            if (input) input.value = '';
            limpiarResultados();
        });
    }
})();
</script>
{% endif %}

{% endblock %}
