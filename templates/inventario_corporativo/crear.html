{% extends "base.html" %}
{% block title %}Crear Producto - Inventario Corporativo{% endblock %}

{% block styles %}
<style>
    .card-inventario {
        border-radius: 0.75rem;
    }
    .card-inventario .card-header {
        border-top-left-radius: 0.75rem;
        border-top-right-radius: 0.75rem;
    }
    .preview-img {
        max-width: 150px;
        max-height: 150px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        object-fit: cover;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <div class="row justify-content-center mt-3">
        <div class="col-lg-8">

            <h2 class="mb-3 fw-bold text-primary text-center">
                <i class="fas fa-plus-circle"></i> Crear Producto Corporativo
            </h2>

            <div class="card card-inventario shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-plus"></i> Nuevo Producto Corporativo
                    </h5>
                    <a href="/inventario-corporativo" class="btn btn-sm btn-light">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>

                <div class="card-body">

                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" enctype="multipart/form-data" id="formCrearProducto" autocomplete="off">
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Nombre -->
                                <div class="mb-3">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" name="nombre" class="form-control" required>
                                </div>

                                <!-- Categor√≠a -->
                                <div class="mb-3">
                                    <label class="form-label">Categor√≠a *</label>
                                    <select name="categoria_id" class="form-select" required>
                                        <option value="">Seleccione</option>
                                        {% for c in categorias %}
                                            <option value="{{ c.id }}">{{ c.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Proveedor -->
                                <div class="mb-3">
                                    <label class="form-label">Proveedor *</label>
                                    <select name="proveedor_id" class="form-select" required>
                                        <option value="">Seleccione</option>
                                        {% for p in proveedores %}
                                            <option value="{{ p.id }}">{{ p.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Valor unitario -->
                                <div class="mb-3">
                                    <label class="form-label">Valor Unitario *</label>
                                    <input type="number" name="valor_unitario" class="form-control" min="0.01" step="0.01" required>
                                </div>

                                <!-- Cantidad -->
                                <div class="mb-3">
                                    <label class="form-label">Cantidad *</label>
                                    <input type="number" name="cantidad" class="form-control" min="1" required>
                                </div>

                                <!-- Cantidad m√≠nima -->
                                <div class="mb-3">
                                    <label class="form-label">Cantidad m√≠nima *</label>
                                    <input type="number" name="cantidad_minima" class="form-control" min="1" required>
                                </div>
                            </div>
                        </div>

                        <!-- Descripci√≥n -->
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n *</label>
                            <textarea name="descripcion" class="form-control" rows="3" maxlength="500" required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- Ubicaci√≥n -->
                                <div class="mb-3">
                                    <label class="form-label">Ubicaci√≥n *</label>
                                    <input type="text" name="ubicacion" class="form-control" value="COQ" readonly required>
                                </div>

                                <!-- Es asignable -->
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="es_asignable" name="es_asignable" checked>
                                    <label class="form-check-label" for="es_asignable">Producto asignable</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Imagen -->
                                <div class="mb-3">
                                    <label class="form-label">Imagen *</label>
                                    <input type="file" name="imagen" class="form-control" accept="image/*" required>
                                    <img id="preview" class="preview-img d-none mt-2" alt="Vista previa">
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <a href="/inventario-corporativo" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal Gesti√≥n de Novedad - INTEGRADO DEL C√ìDIGO ANTERIOR -->
<div class="modal fade" id="modalGestionNovedad" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">‚öôÔ∏è Gesti√≥n de Novedad</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>üìÑ Informaci√≥n de la novedad</h6>
                        <p><strong>ID Solicitud:</strong> <span id="gn_solicitud"></span></p>
                        <p><strong>ID Novedad:</strong> <span id="gn_novedad_id"></span></p>
                        <p><strong>Tipo:</strong> <span id="gn_tipo"></span></p>
                        <p><strong>Cantidad Afectada:</strong> <span id="gn_cantidad"></span></p>
                        <p><strong>Estado:</strong> <span id="gn_estado"></span></p>
                        <p><strong>Registrada por:</strong> <span id="gn_usuario_registra"></span></p>
                        <p><strong>Fecha Registro:</strong> <span id="gn_fecha_registro"></span></p>
                        <p><strong>Descripci√≥n:</strong></p>
                        <p id="gn_descripcion" class="border rounded p-2 bg-light" style="min-height: 60px;"></p>
                    </div>
                    <div class="col-md-4">
                        <h6>üñº Imagen</h6>
                        <div id="gn_contenedor_imagen" class="border rounded text-center p-2 bg-light" style="min-height: 220px;">
                            <img id="gn_imagen" src="" alt="Imagen Novedad" class="img-fluid rounded" style="max-height: 200px; display:none;">
                            <p id="gn_sin_imagen" class="text-muted mt-2" style="display:none;">Sin imagen asociada</p>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <label for="gn_observaciones" class="form-label">Observaciones de resoluci√≥n (opcional):</label>
                    <textarea id="gn_observaciones" class="form-control" rows="3" placeholder="Observaciones al aceptar o rechazar la novedad..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" id="btnRechazarNovedad" class="btn btn-danger" onclick="procesarGestionNovedad('rechazar')">‚ùå Rechazar Novedad</button>
                <button type="button" id="btnAceptarNovedad" class="btn btn-success" onclick="procesarGestionNovedad('aceptar')">‚úÖ Aceptar Novedad</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novedad - PARA CONSISTENCIA -->
<div class="modal fade" id="modalNovedad" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">üìù Registrar Novedad</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Material:</strong> <span id="infoMaterialNovedad"></span></p>
                <p><strong>Solicitante:</strong> <span id="infoSolicitanteNovedad"></span></p>
                <p><strong>Cantidad Entregada:</strong> <span id="infoCantidadNovedad"></span></p>
                
                <form id="formNovedad">
                    <input type="hidden" id="solicitudIdNovedad" name="solicitud_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipoNovedad" class="form-label">Tipo de Novedad:</label>
                                <select class="form-select" id="tipoNovedad" name="tipo_novedad" required>
                                    <option value="">Seleccione...</option>
                                    <option value="da√±o">Da√±o o Rotura</option>
                                    <option value="perdida">P√©rdida</option>
                                    <option value="defectuoso">Material Defectuoso</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cantidadAfectada" class="form-label">Cantidad Afectada:</label>
                                <input type="number" class="form-control" id="cantidadAfectada" name="cantidad_afectada" min="1" required>
                                <div class="form-text">M√°ximo: <span id="maximoNovedad"></span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="descripcionNovedad" class="form-label">Descripci√≥n:</label>
                        <textarea class="form-control" id="descripcionNovedad" name="descripcion" rows="3" placeholder="Describa la novedad en detalle..." required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="imagenNovedad" class="form-label">Imagen de la Novedad (Obligatoria):</label>
                        <input type="file" class="form-control" id="imagenNovedad" name="imagen_novedad" accept="image/*" onchange="mostrarVistaPrevia(this)" required>
                        <div class="form-text">Formatos permitidos: JPG, PNG, GIF. Tama√±o m√°ximo: 5MB</div>
                    </div>
                    
                    <!-- Vista previa de imagen -->
                    <div id="vistaPreviaImagen" class="text-center mt-3" style="display: none;">
                        <h6>Vista Previa:</h6>
                        <img id="previewImg" src="#" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;" alt="Vista previa">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarRegistroNovedad()">üìù Registrar Novedad</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const img = document.getElementById("preview");
    const fileInput = document.querySelector("input[name=imagen]");

    fileInput.addEventListener("change", function (e) {
        const f = e.target.files[0];
        if (!f) {
            img.classList.add("d-none");
            img.src = "";
            return;
        }
        const reader = new FileReader();
        reader.onload = function (ev) {
            img.src = ev.target.result;
            img.classList.remove("d-none");
        };
        reader.readAsDataURL(f);
    });
});

/* ============================
   FUNCIONES PARA NOVEDADES - INTEGRADAS
============================ */
let solicitudIdNovedad = null;
let cantidadMaximaNovedad = 0;

function mostrarModalNovedad(id, materialNombre, solicitanteNombre, cantidadEntregada) {
    solicitudIdNovedad = id;
    cantidadMaximaNovedad = cantidadEntregada;

    document.getElementById("infoMaterialNovedad").textContent = materialNombre;
    document.getElementById("infoSolicitanteNovedad").textContent = solicitanteNombre;
    document.getElementById("infoCantidadNovedad").textContent = cantidadEntregada;
    document.getElementById("maximoNovedad").textContent = cantidadEntregada;

    // Limpiar formulario
    document.getElementById("tipoNovedad").value = "";
    document.getElementById("cantidadAfectada").value = "";
    document.getElementById("descripcionNovedad").value = "";
    document.getElementById("solicitudIdNovedad").value = id;
    document.getElementById("imagenNovedad").value = "";
    document.getElementById("vistaPreviaImagen").style.display = "none";

    const inputCantidad = document.getElementById("cantidadAfectada");
    inputCantidad.max = cantidadEntregada;
    inputCantidad.placeholder = `M√°ximo: ${cantidadEntregada}`;

    new bootstrap.Modal(document.getElementById("modalNovedad")).show();
}

function mostrarVistaPrevia(input) {
    const vistaPrevia = document.getElementById("vistaPreviaImagen");
    const previewImg = document.getElementById("previewImg");
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        const tiposPermitidos = ['image/jpeg', 'image/png', 'image/gif'];
        if (!tiposPermitidos.includes(file.type)) {
            alert('Solo se permiten archivos de imagen (JPG, PNG, GIF)');
            input.value = '';
            vistaPrevia.style.display = "none";
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La imagen no puede superar los 5MB');
            input.value = '';
            vistaPrevia.style.display = "none";
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            vistaPrevia.style.display = "block";
        }
        reader.readAsDataURL(file);
    } else {
        vistaPrevia.style.display = "none";
    }
}

function confirmarRegistroNovedad() {
    const tipoNovedad = document.getElementById("tipoNovedad").value;
    const cantidadAfectada = parseInt(document.getElementById("cantidadAfectada").value);
    const descripcion = document.getElementById("descripcionNovedad").value.trim();
    const imagenInput = document.getElementById("imagenNovedad");
    const imagenArchivo = imagenInput.files[0];

    // Validaciones
    if (!tipoNovedad) {
        alert("‚ùå Seleccione el tipo de novedad");
        return;
    }

    if (!cantidadAfectada || cantidadAfectada < 1) {
        alert("‚ùå Ingrese una cantidad v√°lida");
        return;
    }

    if (cantidadAfectada > cantidadMaximaNovedad) {
        alert(`‚ùå La cantidad no puede superar ${cantidadMaximaNovedad}`);
        return;
    }

    if (!descripcion || descripcion.length < 10) {
        alert("‚ùå La descripci√≥n es obligatoria y debe tener al menos 10 caracteres");
        return;
    }

    if (!imagenArchivo) {
        alert("‚ùå Debe adjuntar una imagen de la novedad");
        return;
    }

    const tiposPermitidos = ['image/jpeg', 'image/png', 'image/gif'];
    if (!tiposPermitidos.includes(imagenArchivo.type)) {
        alert('‚ùå Solo se permiten archivos de imagen (JPG, PNG, GIF)');
        return;
    }

    if (imagenArchivo.size > 5 * 1024 * 1024) {
        alert('‚ùå La imagen no puede superar los 5MB');
        return;
    }

    // Mostrar loading
    const btn = document.querySelector('#modalNovedad .btn.btn-primary');
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Registrando...';
    btn.disabled = true;

    // Crear FormData
    const formData = new FormData();
    formData.append('solicitud_id', solicitudIdNovedad);
    formData.append('tipo_novedad', tipoNovedad);
    formData.append('cantidad_afectada', cantidadAfectada);
    formData.append('descripcion', descripcion);
    formData.append('imagen_novedad', imagenArchivo);

    fetch('/solicitudes/registrar-novedad', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + (data.message || 'Novedad registrada exitosamente'));
            bootstrap.Modal.getInstance(document.getElementById('modalNovedad')).hide();
            location.reload();
        } else {
            alert('‚ùå ' + (data.message || 'Error al registrar la novedad'));
        }
    })
    .catch(error => {
        alert('‚ùå Error al registrar la novedad');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

/* ============================
   GESTI√ìN DE NOVEDADES (ACEPTAR / RECHAZAR)
============================ */
let solicitudIdGestionNovedad = null;

function mostrarModalGestionNovedad(solicitudId) {
    solicitudIdGestionNovedad = solicitudId;

    // limpiar campos
    document.getElementById("gn_solicitud").textContent = '';
    document.getElementById("gn_novedad_id").textContent = '';
    document.getElementById("gn_tipo").textContent = '';
    document.getElementById("gn_cantidad").textContent = '';
    document.getElementById("gn_estado").textContent = '';
    document.getElementById("gn_usuario_registra").textContent = '';
    document.getElementById("gn_fecha_registro").textContent = '';
    document.getElementById("gn_descripcion").textContent = '';
    document.getElementById("gn_observaciones").value = '';

    const img = document.getElementById("gn_imagen");
    const sinImg = document.getElementById("gn_sin_imagen");
    img.style.display = "none";
    sinImg.style.display = "none";

    fetch(`/solicitudes/api/${solicitudId}/novedad`)
        .then(r => {
            if (!r.ok) throw new Error('Error HTTP ' + r.status);
            return r.json();
        })
        .then(data => {
            if (!data.success) {
                alert('‚ùå ' + (data.error || 'No se pudo cargar la novedad'));
                return;
            }

            const n = data.novedad;
            document.getElementById("gn_solicitud").textContent = '#' + (n.solicitud_id || '');
            document.getElementById("gn_novedad_id").textContent = n.novedad_id || '';
            document.getElementById("gn_tipo").textContent = n.tipo_novedad || '';
            document.getElementById("gn_cantidad").textContent = n.cantidad_afectada != null ? n.cantidad_afectada : '-';
            document.getElementById("gn_estado").textContent = n.estado_novedad || '';
            document.getElementById("gn_usuario_registra").textContent = n.usuario_registra || '';
            document.getElementById("gn_fecha_registro").textContent = n.fecha_registro || '';
            document.getElementById("gn_descripcion").textContent = n.descripcion || '';

            if (n.imagen_url) {
                img.src = n.imagen_url;
                img.style.display = "block";
                sinImg.style.display = "none";
            } else {
                img.style.display = "none";
                sinImg.style.display = "block";
            }

            new bootstrap.Modal(document.getElementById("modalGestionNovedad")).show();
        })
        .catch(err => {
            console.error(err);
            alert('‚ùå Error al cargar la novedad');
        });
}

function procesarGestionNovedad(accion) {
    if (!solicitudIdGestionNovedad) {
        alert('Solicitud no v√°lida');
        return;
    }

    const msg = accion === 'aceptar'
        ? '¬øEst√° seguro que desea ACEPTAR la novedad?'
        : '¬øEst√° seguro que desea RECHAZAR la novedad?';

    if (!confirm(msg)) return;

    const observaciones = document.getElementById("gn_observaciones").value.trim();

    const btn = (accion === 'aceptar')
        ? document.getElementById("btnAceptarNovedad")
        : document.getElementById("btnRechazarNovedad");

    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Procesando...';
    btn.disabled = true;

    const formData = new FormData();
    formData.append('solicitud_id', solicitudIdGestionNovedad);
    formData.append('accion', accion);
    formData.append('observaciones', observaciones);

    fetch('/solicitudes/gestionar-novedad', {
        method: 'POST',
        body: formData
    })
    .then(r => {
        if (!r.ok) throw new Error('Error HTTP ' + r.status);
        return r.json();
    })
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Novedad ${accion === 'aceptar' ? 'aceptada' : 'rechazada'} exitosamente`);
            bootstrap.Modal.getInstance(document.getElementById("modalGestionNovedad")).hide();
            location.reload();
        } else {
            alert('‚ùå ' + (data.message || 'Error al procesar la novedad'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('‚ùå Error al procesar la novedad');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}
</script>
{% endblock %}