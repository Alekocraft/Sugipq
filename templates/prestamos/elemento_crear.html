{% extends "base.html" %}

{% block title %}Crear Material{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Crear Material</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/prestamos/crear">
        <i class="bi bi-arrow-left"></i> Volver a préstamo
      </a>
      <a class="btn btn-outline-secondary btn-sm" href="/prestamos">
        <i class="bi bi-list"></i> Ver préstamos
      </a>
    </div>
  </div>

  <div id="alertContainer"></div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form id="materialForm" method="POST" enctype="multipart/form-data" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="nombre_elemento">Nombre del material</label>
            <input class="form-control" type="text" id="nombre_elemento" name="nombre_elemento" maxlength="200" required />
          </div>
          <div class="col-md-3">
            <label class="form-label" for="valor_unitario">Valor unitario</label>
            <input class="form-control" type="number" id="valor_unitario" name="valor_unitario" min="0" step="0.01" required />
          </div>
          <div class="col-md-3">
            <label class="form-label" for="cantidad_disponible">Cantidad disponible</label>
            <input class="form-control" type="number" id="cantidad_disponible" name="cantidad_disponible" min="0" step="1" required />
          </div>
          <div class="col-md-3">
            <label class="form-label" for="cantidad_minima">Cantidad mínima</label>
            <input class="form-control" type="number" id="cantidad_minima" name="cantidad_minima" min="0" step="1" required />
          </div>
          <div class="col-md-9">
            <label class="form-label" for="imagen">Imagen (opcional)</label>
            <input class="form-control" type="file" id="imagen" name="imagen" accept="image/png,image/jpeg,image/webp,image/gif" />
            <div class="form-text">Formatos permitidos: png, jpg, jpeg, webp, gif.</div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check2-circle"></i> Crear material
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="safeNavigate('/prestamos/crear');">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function safeNavigate(path) {
    try {
      if (typeof path !== 'string') return;
      const dest = path.trim();
      if (!dest.startsWith('/') || dest.startsWith('//')) return;
      if (dest.includes('\\') || /[\r\n\t]/.test(dest)) return;
      window.location.assign(dest);
    } catch (e) { /* no-op */ }
  }

  function showAlert(message, type) {
    const container = document.getElementById('alertContainer');
    if (!container) return;
    container.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'alert alert-' + (type || 'info') + ' alert-dismissible fade show';
    div.role = 'alert';
    const span = document.createElement('span');
    span.textContent = message || '';
    div.appendChild(span);

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn-close';
    btn.setAttribute('data-bs-dismiss', 'alert');
    btn.setAttribute('aria-label', 'Close');
    div.appendChild(btn);

    container.appendChild(div);
  }

  (function init() {
    const form = document.getElementById('materialForm');
    if (!form) return;

    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();
      const fd = new FormData(form);

      try {
        const resp = await fetch('/prestamos/elementos/crearmaterial', {
          method: 'POST',
          body: fd,
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        let data = null;
        try { data = await resp.json(); } catch (e) { data = null; }

        if (!resp.ok) {
          const msg = (data && data.message) ? data.message : 'No fue posible crear el material.';
          showAlert(msg, 'danger');
          return;
        }

        if (data && data.success) {
          showAlert(data.message || 'Material creado correctamente.', 'success');
          // Volver a crear préstamo para poder seleccionarlo
          setTimeout(() => safeNavigate('/prestamos/crear'), 500);
          return;
        }

        showAlert((data && data.message) ? data.message : 'No fue posible crear el material.', 'warning');

      } catch (e) {
        showAlert('Error de red o del servidor.', 'danger');
      }
    });
  })();
</script>
{% endblock %}
