{% extends "base.html" %}

{% block title %}Crear Préstamo{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Crear Préstamo</h1>
    <div class="d-flex gap-2">
      {% if can_access('materiales', 'create') %}
      <a class="btn btn-outline-secondary btn-sm" href="/prestamos/elementos/crearmaterial">
        <i class="bi bi-plus-circle"></i> Crear material
      </a>
      {% endif %}
      <a class="btn btn-outline-secondary btn-sm" href="/prestamos">
        <i class="bi bi-arrow-left"></i> Volver
      </a>
    </div>
  </div>

  <div id="alertContainer"></div>

  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <form id="prestamoForm" method="POST">
            <div class="mb-3">
              <label for="elemento_id" class="form-label">Elemento</label>
              <select class="form-select" id="elemento_id" name="elemento_id" required>
                <option value="">Seleccione un elemento...</option>
                {% for e in elementos %}
                <option
                  value="{{ e.id }}"
                  data-nombre="{{ e.nombre|e }}"
                  data-valor="{{ e.valor }}"
                  data-disponible="{{ e.disponible }}"
                  data-imagen="{{ e.imagen|default('')|e }}"
              >
                  {{ e.nombre }} (Disp: {{ e.disponible }})
                </option>
                {% endfor %}
              </select>
              <div class="form-text">Solo se listan elementos activos y disponibles.</div>
            </div>

            <div class="row g-2">
              <div class="col-md-4">
                <label for="cantidad" class="form-label">Cantidad</label>
                <input class="form-control" type="number" min="1" step="1" id="cantidad" name="cantidad" required />
              </div>
              <div class="col-md-8">
                <label for="fecha_prevista" class="form-label">Fecha devolución prevista</label>
                <input class="form-control" type="date" id="fecha_prevista" name="fecha_prevista" required />
              </div>
            </div>

            <div class="mt-3">
              <label for="evento" class="form-label">Evento / Motivo</label>
              <input class="form-control" type="text" id="evento" name="evento" maxlength="200" required />
            </div>

            <div class="mt-3">
              <label for="observaciones" class="form-label">Observaciones</label>
              <textarea class="form-control" id="observaciones" name="observaciones" rows="3" maxlength="1000" required></textarea>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check2-circle"></i> Crear préstamo
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="safeNavigate('/prestamos');">
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm" id="resumenCard">
        <div class="card-body">
          <h2 class="h6">Resumen</h2>
          <div class="d-flex gap-3">
            <div style="width: 96px; height: 96px; flex: 0 0 auto;">
              <img id="resumenImagen" src="" alt="Imagen del material" class="img-fluid rounded border" style="object-fit: cover; width: 96px; height: 96px; display:none;">
              <div id="resumenSinImagen" class="border rounded d-flex align-items-center justify-content-center text-muted" style="width: 96px; height: 96px;">
                <span style="font-size: 12px;">Sin imagen</span>
              </div>
            </div>
            <div class="flex-grow-1">
              <div class="mb-1"><strong>Material:</strong> <span id="resumenMaterial">—</span></div>
              <div class="mb-1"><strong>Disponible:</strong> <span id="resumenDisponible">—</span></div>
              <div class="mb-1"><strong>Valor unitario:</strong> <span id="resumenValorUnitario">—</span></div>
              <div class="mb-1"><strong>Cantidad:</strong> <span id="resumenCantidad">—</span></div>
              <div class="mt-2"><strong>Subtotal:</strong> <span id="resumenSubtotal">—</span></div>
            </div>
          </div>
          <hr>
          <small class="text-muted">
            El préstamo quedará en estado <strong>PENDIENTE</strong> hasta aprobación.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Navegación segura (misma-origen)
  function safeNavigate(path) {
    try {
      if (typeof path !== 'string') return;
      const dest = path.trim();
      if (!dest.startsWith('/') || dest.startsWith('//')) return;
      if (dest.includes('\\') || /[\r\n\t]/.test(dest)) return;
      window.location.assign(dest);
    } catch (e) { /* no-op */ }
  }

  function showAlert(message, type) {
    const container = document.getElementById('alertContainer');
    if (!container) return;
    container.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'alert alert-' + (type || 'info') + ' alert-dismissible fade show';
    div.role = 'alert';
    const span = document.createElement('span');
    span.textContent = message || '';
    div.appendChild(span);

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn-close';
    btn.setAttribute('data-bs-dismiss', 'alert');
    btn.setAttribute('aria-label', 'Close');
    div.appendChild(btn);

    container.appendChild(div);
  }

  function formatCOP(value) {
    const n = Number(value || 0);
    try {
      return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(n);
    } catch (e) {
      return '$ ' + Math.round(n).toString();
    }
  }

  function updateResumen() {
    const sel = document.getElementById('elemento_id');
    const qtyInput = document.getElementById('cantidad');
    const opt = sel && sel.selectedOptions ? sel.selectedOptions[0] : null;

    const material = opt ? (opt.dataset.nombre || '—') : '—';
    const disponible = opt ? (opt.dataset.disponible || '—') : '—';
    const valor = opt ? Number(opt.dataset.valor || 0) : 0;
    const imagen = opt ? (opt.dataset.imagen || '') : '';
    const qty = Number(qtyInput && qtyInput.value ? qtyInput.value : 0);

    document.getElementById('resumenMaterial').textContent = material;
    document.getElementById('resumenDisponible').textContent = disponible;
    document.getElementById('resumenValorUnitario').textContent = formatCOP(valor);
    document.getElementById('resumenCantidad').textContent = qty > 0 ? String(qty) : '—';
    document.getElementById('resumenSubtotal').textContent = qty > 0 ? formatCOP(valor * qty) : '—';

    const imgEl = document.getElementById('resumenImagen');
    const noImgEl = document.getElementById('resumenSinImagen');
    if (imagen) {
      imgEl.src = imagen;
      imgEl.style.display = '';
      noImgEl.style.display = 'none';
    } else {
      imgEl.removeAttribute('src');
      imgEl.style.display = 'none';
      noImgEl.style.display = '';
    }
  }

  (function init() {
    const sel = document.getElementById('elemento_id');
    const qty = document.getElementById('cantidad');
    if (sel) sel.addEventListener('change', updateResumen);
    if (qty) qty.addEventListener('input', updateResumen);

    updateResumen();

    const form = document.getElementById('prestamoForm');
    if (!form) return;

    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();

      const formData = new FormData(form);

      try {
        const resp = await fetch('/prestamos/crear', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        let data = null;
        try { data = await resp.json(); } catch (e) { data = null; }

        if (!resp.ok) {
          const msg = (data && data.message) ? data.message : 'No fue posible crear el préstamo.';
          showAlert(msg, 'danger');
          return;
        }

        if (data && data.success) {
          showAlert(data.message || 'Préstamo creado correctamente.', 'success');
          if (data.redirect) {
            setTimeout(() => safeNavigate(data.redirect), 400);
          } else {
            setTimeout(() => safeNavigate('/prestamos'), 400);
          }
          return;
        }

        showAlert((data && data.message) ? data.message : 'No fue posible crear el préstamo.', 'warning');

      } catch (e) {
        showAlert('Error de red o del servidor.', 'danger');
      }
    });
  })();
</script>
{% endblock %}
